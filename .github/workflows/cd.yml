name: CD

on:
  workflow_call:
    inputs:
      release_tag:
        required: true
        type: string
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

permissions:
  contents: write

env:
  DOTNET_VERSION: 10.0.x
  PROJECT_PATH: src/CrawlerCli/CrawlerCli.csproj

jobs:
  publish-native:
    name: Publish ${{ matrix.rid }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            binary: CrawlerCli.exe
            extension: exe
          - os: macos-14
            rid: osx-x64
            binary: CrawlerCli
            extension: tar.gz
          - os: macos-14
            rid: osx-arm64
            binary: CrawlerCli
            extension: tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: ${{ env.PROJECT_PATH }}

      - name: Restore
        run: dotnet restore ${{ env.PROJECT_PATH }} --runtime ${{ matrix.rid }} --nologo

      - name: Publish
        run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --runtime ${{ matrix.rid }} --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=false --nologo --output artifacts/publish/${{ matrix.rid }}

      - name: Package release asset
        id: package
        shell: bash
        run: |
          mkdir -p artifacts/release
          if [[ "${{ matrix.extension }}" == "exe" ]]; then
            asset_path="artifacts/release/crawler-${{ inputs.release_tag }}-${{ matrix.rid }}.exe"
            cp "artifacts/publish/${{ matrix.rid }}/${{ matrix.binary }}" "$asset_path"
          else
            asset_path="artifacts/release/crawler-${{ inputs.release_tag }}-${{ matrix.rid }}.tar.gz"
            tar -C "artifacts/publish/${{ matrix.rid }}" -czf "$asset_path" "${{ matrix.binary }}"
          fi
          echo "asset_path=$asset_path" >> "$GITHUB_OUTPUT"

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.rid }}
          path: ${{ steps.package.outputs.asset_path }}

  publish-flatpak:
    name: Publish linux-x64 flatpak
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: ${{ env.PROJECT_PATH }}

      - name: Restore
        run: dotnet restore ${{ env.PROJECT_PATH }} --runtime linux-x64 --nologo

      - name: Publish linux-x64
        run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --runtime linux-x64 --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=false --nologo --output artifacts/publish/linux-x64

      - name: Install Flatpak tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08

      - name: Build flatpak bundle
        run: |
          mkdir -p artifacts/release
          flatpak-builder --user --force-clean --repo=flatpak-repo flatpak-build packaging/flatpak/io.github.bruno.crawler.json
          flatpak build-bundle flatpak-repo "artifacts/release/crawler-${{ inputs.release_tag }}-linux-x64.flatpak" io.github.bruno.crawler stable

      - name: Upload flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-linux-x64-flatpak
          path: artifacts/release/crawler-${{ inputs.release_tag }}-linux-x64.flatpak

  publish-docker:
    name: Publish Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: bruno/crawler
          tags: |
            type=raw,value=${{ inputs.release_tag }}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  release:
    name: Publish GitHub Release assets
    runs-on: ubuntu-latest
    needs:
      - publish-native
      - publish-flatpak
      - publish-docker
    steps:
      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          files: release-assets/*
          fail_on_unmatched_files: true
          generate_release_notes: true
